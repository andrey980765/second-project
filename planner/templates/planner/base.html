{% load static %}
<!doctype html>
<html lang="{{ settings.language|default:'ru' }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}EventPlanner{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'planner/styles.css' %}">
</head>
<body class="theme-{{ settings.theme|default:'light' }}">
  <header class="site-header">
    <h1><a href="{% url 'planner:index' %}">EventPlanner</a></h1>
    <nav>
      {% if settings.language == 'ru' %}
        <a href="{% url 'planner:index' %}">–ì–ª–∞–≤–Ω–∞—è</a> |
        <a href="{% url 'planner:event_create' %}">–°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</a> |
        <a href="{% url 'planner:settings' %}">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
      {% else %}
        <a href="{% url 'planner:index' %}">Home</a> |
        <a href="{% url 'planner:event_create' %}">Create Event</a> |
        <a href="{% url 'planner:settings' %}">Settings</a>
      {% endif %}
    </nav>

    <div class="notifications-container">
  <button id="notif-btn">
    üîî <span id="notif-count" class="badge">0</span>
  </button>
  <div id="notif-dropdown" class="notif-dropdown hidden">
    <ul id="notif-list"></ul>
    <div class="notif-actions">
      <button id="mark-all-seen">–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</button>
      <button id="delete-all">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ</button>
    </div>
  </div>
</div>
  </header>

  <main>
    {% block content %}{% endblock %}
  </main>

  <footer><small></small></footer>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
      const notifBtn = document.getElementById("notif-btn");
      const notifDropdown = document.getElementById("notif-dropdown");
      const notifList = document.getElementById("notif-list");
      const notifCount = document.getElementById("notif-count");

      function loadNotifications() {
          fetch("{% url 'planner:notifications_list' %}")
              .then(r => r.json())
              .then(data => {
                  notifCount.textContent = data.count;
                  notifList.innerHTML = "";
                  if (data.items.length === 0) {
                      notifList.innerHTML = "<li>–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</li>";
                  } else {
                      data.items.forEach(n => {
                          const li = document.createElement("li");
                          li.textContent = n.message + " (" + n.created_at + ")";
                          notifList.appendChild(li);
                      });
                  }
              });
      }

    // –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å dropdown
    notifBtn.addEventListener("click", function () {
        notifDropdown.classList.toggle("hidden");
    });

    // –æ—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
    document.getElementById("mark-all-seen").addEventListener("click", function () {
        fetch("{% url 'planner:notifications_mark_seen' %}", {
            method: "POST",
            headers: {"X-CSRFToken": "{{ csrf_token }}"}
        }).then(() => {
            notifCount.textContent = "0";
            loadNotifications();
        });
    });

    // —É–¥–∞–ª–∏—Ç—å –≤—Å–µ
    document.getElementById("delete-all").addEventListener("click", function () {
        fetch("{% url 'planner:notifications_delete_all' %}", {
            method: "POST",
            headers: {"X-CSRFToken": "{{ csrf_token }}"}
        }).then(() => {
            notifCount.textContent = "0";
            notifList.innerHTML = "<li>–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</li>";
        });
    });

    // –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ + –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
    loadNotifications();
    setInterval(loadNotifications, 30000);
});
</script>

  {% block scripts %}{% endblock %}
</body>
</html>
